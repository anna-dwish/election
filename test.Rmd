---
title: "Case Study 3 Interim Report: Who Votes in North Carolina?"
author: "Ethan Shen, Malavi Ravindran, Steven Herrera Tenorio, Anna Darwish"
geometry: "left=1.25cm,right=1.25cm,top=1.3cm,bottom=1.3cm"
output: pdf_document
---

```{r, function checking for installed packages, include=FALSE}
# Validate that all necessary packaged have been downloaded, install otherwise or throw err package DNE
pkgTest <- function(x)
{
  if (!require(x,character.only = TRUE))
  {
    install.packages(x,repos = "http://cran.r-project.org", dep=TRUE)
    if(!require(x,character.only = TRUE)) stop("Package not found")
  }
}
```

```{r package test, include=FALSE}
# Installing packages
pkgTest("knitr")
pkgTest("tidyverse")
pkgTest("optimx")
pkgTest("lme4")
pkgTest("plyr")
pkgTest("lmerTest")
pkgTest("glmnet")
pkgTest("optimx")
pkgTest("groupdata2")
pkgTest("merTools")
pkgTest("sjPlot")
pkgTest("cvAUC")
pkgTest("pander")
pkgTest("ggplot2")
pkgTest("tidyr")
pkgTest("dplyr")
pkgTest("grid")
pkgTest("maps")
pkgTest("scales")
pkgTest("webshot")
pkgTest("magick")
pkgTest("cvms")
pkgTest("png")
```

```{r load packages, include=FALSE}
library(tidyverse)
library(optimx)
library(lme4)
library(plyr)
library(lmerTest)
library(glmnet)
library(optimx)
library(groupdata2)
library(merTools)
library(sjPlot)
library(cvAUC)
library(pander)
library(grid)
library(maps)
library(scales)
library(ggplot2)
library(tidyr)
library(dplyr)
library(webshot)
library(magick)
library(cvms)
library(png)
library(knitr)
webshot::install_phantomjs()
knitr::opts_chunk$set(echo = F)
```

# Introduction

In 2019, the Supreme Court asserted that federal courts were not allowed to rule cases on partisan gerrymandering, which allows parties that control the state legislature to draw district maps and influence election outcomes (see Rucho v. Common Cause 2019). North Carolina was at the spotlight of this contested 5-4 ruling, cultivating national dialogue about the consequences of district map drawing, such as voter suppression. Our study aims to uncover demographic characteristics, such race, gender, age group, and county of residence, driving voting patterns in North Carolina. We ultimately seek to answer the following question-- *who* votes in North Carolina? Answering this will not only allow for better predictions for the outcomes of Congressional elections, but will also illuminate which demographic groups in the state are hindered from civic engagement, whether by implicit or explicit means. This information can be instrumental to campaigns and activist groups seeking to bolster support and foster more politically minded communities. 

Our study will use publicly available voter, registration, and census data in order to determine the number of likely and unlikely voters across various demographic groups in the 100 counties of North Carolina. After performing data munging and harmonization, we implement a multilevel logistic regression model with random county intercepts to make statements regarding an individual's likelihood of voting. In order to assess the performance of the model, we perform both 5-fold cross validation and out of sample validation using data from the 2012 elections. We conclude with a discussion of which demographic characteristics have a significant impact on the likelihood of voting, quantifications of these relationships, and limitations to our data and analysis 

# Data Description

Data for this study comes from North Carolina voter history, North Carolina voter registration information, and the census. Voting and registration data were used in conjunction with the census in order to not only understand who votes, but also who *does not*. Below we describe these various data sources as well as the munging and harmonization process used to obtain a singular, comprehensive dataset. 

## Voter History and Registration Data

The North Carolina voter history dataset shows how each voter in North Carolina, uniquely identified by a voter registration number, voted in the 2016 presidential and 2018 congressional elections. As not all voters participated in both elections, we designated those who voted in 2016 as “likely” voters for the 2020 elections. This decision was made due to the fact that both 2016 and 2020 are presidential election years. 

The North Carolina voter registration dataset contains all legally available voter specific information for eligible voters in the state. Individuals for whom the most recent last voted date was greater than ten years were not included in the dataset. Information provided for each voter includes their county of residence, unique voter registration number, race, ethnicity, gender, and age. In this dataset, race could take on one of the following categories:

* Asian
* Black or African American
* American Indian or Alaska Native
* Two or more races 
* Other
* Native Hawaiian or Pacific Islander
* Undesignated
* White

Ethnicity was one of the following:

* Hispanic or Latino
* Not Hispanic or Not Latino
* Undesignated

And gender belonged to one of: 
* Male
* Female
* Undetermined

Recall that, in our study, a "likely" voter was one who voted in the 2016 election. Thus, not all individuals in the North Carolina registration dataset were necessarily “likely” voters. This is because certain individuals who were registered to vote and *did* vote within the last 10 years still may not have voted in the 2016 election. Thus, upon joining the voter and registration data by unique voter registration number, only those individuals who were both registered and voted in the 2016 election were kept. In this sense, only “likely” voters remained in the merged data frame. 

After joining the two data sources by  voter registration number, certain modifications were made to facilitate analysis. Firstly, age was converted to a categorical variable, $age \ bin$, which belonged to one of five categories. 

* 18-29
* 30-39
* 40-49
* 50-64
* 65+ 

In addition, the individual race and ethnic identities were combined into a $race \ and \ ethnicity$ variable which was one of:

* Hispanic any race
* Non Hispanic White
* Non Hispanic Black
* Non Hispanic Other
* Non Hispanic Asian
* Non Hispanic Mixed
* Non Hispanic American Indian or Alaska Native
* Non Hispanic Native Hawaiian or Pacific Islander
* Undetermined

Note that all individuals of hispanic ethnicity were grouped into one category, regardless of racial identity. Once these modifications were made, the data was grouped by $county$, $race \ and \ ethnicity$, $age \ bin$, and $gender$. The size of each group, which is synonymous with the number of likely voters in that group, was included in the data frame as well. For example, one row of the grouped data frame would report the number of likely voters among 18-29 year old, hispanic women in Alamance county. This dataset will be referred to as “Voting and Registration” for the continuation of the paper.

## Census Data

The data harmonization process described above finds the number of likely voters in the 2020 election. However, this ignores the population of North Carolinans who are not likely to vote. Thus, in order to properly address the question of who does and does not vote in North Carolina, census data was utilized. This data helped to provide a better sense of the *denominator* in our calculations-- that is, what is the total size of each demographic group in the 100 counties of North Carolina, and how does compare to that of only likely voters in each group?

The census data includes, for each county, census year, and age group, the population size by various demographic identities. Examples of these groups include females, hispanic males, and non hispanic females who identify black alone or in combination. It is clear that the groups that are represented in the census data range from very broad (gender) to the very granular (a combination of gender, ethnicity, and race). As these granular identities accout for both race and ethnicity, they were consistent with the $race \ and \ ethnicity$ variable defined in the “Voting and Registration” dataset. 

In order to format the data in a way that would be easily merged with “Voting and Registration”, the census data was filtered for the most recent year and for age groups that were at or greater than the 15-19 bin. For those rows where the age group of interest fell within the 15-19 bin, each population size was divided by 2.5 in order to theoretically account for only those individuals who were 18 or above (and thus eligible to vote). Then, as the census age bins were smaller than those that were created for “Voting and Registration”, population information was summed over each of the smaller age bin categories in order to create age bins consistent with those previously defined for “Voting and Registration”. Finally, using the census counts provided for each demographic group (by gender, age group, and race and ethnicity) within each county, a new dataframe was constructed with each row representing a county, racial and ethnic group, age bin, and gender and total group size. As can be seen, the format of this dataset was consistent with “Voting and Registration,” but with an additional value representing the total group size. This dataset will be referred to as “Census”.

The “Voting and Registration” and “Census” datasets were then merged by county, age bin, race and ethnicity, and gender. This final data frame reports, for each demographic group within each county, the number of likely voters (our numerator of interest) as well as the total size (our denominator of interest). This merging process was not perfect, as there were some inconsistencies between information provided by the "Census" and "Voting and Registration" datasets. For example, the census provided counts of only male and female populations. For this reason, those registered voters who specified a gender other than male or female were omitted in this dataset. Those with undesignated racial and ethnic identities were excluded for similar reasons. Similarly, we found that there were no instances of "Native Hawaiian or Pacific Islander" individuals who voted in 2016, necessating their removal from the dataset. The limitations of these decisions will be discussed more thoroughly in section ____. 


# Exploratory Data Analysis

```{r Read Data}
who_votes_data <- readRDS("who_votes_data_2016.Rds")
```

```{r EDA p1, fig.width=9, fig.align="center", warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
# This code chunk prefaces some of the other package load-ins because of conflicts with select fuctionality 
who_votes_data %>% 
  dplyr::select(race_ethnicity, age_bin, gender,Likely,Unlikely) %>%
  dplyr::group_by(race_ethnicity, age_bin, gender) %>% 
  dplyr::summarize(Likely = sum(Likely), 
          Unlikely = sum(Unlikely), 
          proportion = Likely/(Likely+Unlikely)) %>% ungroup() %>% 
  ggplot(aes(x = age_bin, y = proportion, fill = gender)) + 
  geom_bar(stat = "identity", position = "dodge") + 
  facet_wrap(~race_ethnicity, nrow = 2) + 
  geom_text(aes(label=paste0(sprintf("%.2f", proportion)), y=proportion/2), 
            position = position_dodge(width = 1),  
            colour="Black", 
            size = 2.2) + 
  labs(x = expression("Age Group"), 
       y= ("Proportion of Likely Voters"), 
       title = "Likely Voters Across Age Groups, Race/Ethnicity, and Sex", 
       caption="Figure 1") +
  theme(plot.caption = element_text(hjust = 0.5, vjust = -0.5, size = 12)) +
  guides(fill=guide_legend(title="Sex"))
```

In Figure 1, we can see the proportion of likely voters across race-ethnicity, sex, and age group identities. There appears to be profound differences in likely voter proportion among the different race-ethnicity groups. *Hispanic Any Race*, *Non-Hispanic American Indian*, *Non-Hispanic Black*, and *Non-Hispanic White* groups generally have a much higher proportion of likely voters relative to other groups in North Carolina.

In general, we see an increasing trend with age for *Non-Hispanic American Indian*, *Non-Hispanic Black*, and *Non-Hispanic White* groups. This trend is actually reversed for *Non-Hispanic Mixed* groups. Finally, we see a varying relationship for is slightly less profound for *Hispanic Any Race* and *Non-Hispanic Asian* groups.

In general, there appears to be a higher proportion of likely voters among women compared to men. However, we see this trend level off in the two oldest age groups.

```{r warning=FALSE, fig.align="center",fig.cap="Visualization of Likely Voters in NC"}
library(tigris)
library(gridExtra)
NCC <- counties(state = "NC", cb = FALSE)
NCC$NAME <- toupper(NCC$NAME)

likely.by.county <- who_votes_data %>% dplyr::select(everything()) %>%
  dplyr::group_by(county_desc) %>% 
  dplyr::summarise(Likely=sum(Likely),
            Unlikely=sum(Unlikely),
            Prop=sum(Likely)/(sum(Likely) + sum(Unlikely))) 

items <- geo_join(NCC,
                  likely.by.county,
                  "NAME", #name of variable in dataset1
                  "county_desc")


# make as pretty as you want
# replace ggplot(NCC) with ggplot(items) if you want to fill the counties by a value
p1 <- ggplot(items) +
  geom_sf(mapping = aes(fill = Prop)) +
  labs(title = "Proportion of Likely Voters in NC by County") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5, size = 7),
        legend.title = element_text(size = 7),
        legend.text = element_text(size = 7),
        axis.text.x = element_text(size = 7),
        axis.text.y = element_text(size = 7)) +
  scale_fill_continuous(high = "#132B43", low = "#56B1F7")

p2 <- ggplot(items) +
  geom_sf(mapping = aes(fill = Likely)) +
  labs(title = "Raw Number of Likely Voters in NC by County") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5, size = 7),
        legend.title = element_text(size = 7),
        legend.text = element_text(size = 7),
        axis.text.x = element_text(size = 7),
        axis.text.y = element_text(size = 7)) +
  scale_fill_continuous(high = "#132B43", low = "#56B1F7")
  
gridExtra::grid.arrange(p1, p2, nrow=1)
```

