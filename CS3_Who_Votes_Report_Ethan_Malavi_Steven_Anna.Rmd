---
title: "Case Study 3 Interim Report: Who Votes in North Carolina?"
author: "Ethan Shen, Malavi Ravindran, Steven Herrera Tenorio, Anna Darwish"
geometry: "left=1.25cm,right=1.25cm,top=1.3cm,bottom=1.3cm"
fontsize: 12pt
output: 
  pdf_document:
     number_sections: true
---

```{r, function checking for installed packages, include=FALSE}
# Validate that all necessary packaged have been downloaded, install otherwise or throw err package DNE
pkgTest <- function(x)
{
  if (!require(x,character.only = TRUE))
  {
    install.packages(x,repos = "http://cran.r-project.org", dep=TRUE)
    if(!require(x,character.only = TRUE)) stop("Package not found")
  }
}
```

```{r package test, include=FALSE}
pkgTest("arm")
pkgTest("brms")
pkgTest("cvAUC")
pkgTest("cvms")
pkgTest("dplyr")
pkgTest("ggplot2")
pkgTest("glmnet")
pkgTest("glmmTMB")
pkgTest("grid")
pkgTest("gridExtra")
pkgTest("groupdata2")
pkgTest("knitr")
pkgTest("lme4")
pkgTest("lmerTest")
pkgTest("maps")
pkgTest("merTools")
pkgTest("optimx")
pkgTest("pander")
pkgTest("plyr")
pkgTest("scales")
pkgTest("sf")
pkgTest("sjPlot")
pkgTest("tidyr")
pkgTest("tidyverse")
```

```{r load packages, include=FALSE}
library(brms)
library(cvAUC)
library(cvms)
library(dplyr)
library(ggplot2)
library(glmnet)
library(glmmTMB)
library(grid)
library(gridExtra)
library(groupdata2)
library(knitr)
library(lme4)
library(lmerTest)
library(maps)
library(merTools)
library(optimx)
library(pander)
library(plyr)
library(scales)
library(sf)
library(sjPlot)
library(tidyr)
library(tidyverse)
knitr::opts_chunk$set(echo = F,
                      message = F,
                      warning = F)
theme_set(theme_classic())
```

# Introduction

In 2019, the Supreme Court asserted that federal courts were not allowed to rule cases on partisan gerrymandering, which allows parties that control the state legislature to draw district maps and influence election outcomes (Rucho v. Common Cause 2019) [[1]][Bibliography]. North Carolina was at the spotlight of this contested 5-4 ruling, cultivating national dialogue about the consequences of district map drawing, such as voter suppression. Our study aims to uncover demographic characteristics, such as race, gender, age group, and county of residence, that drive voting patterns in North Carolina. We ultimately seek to answer the following question -- *who* votes in North Carolina? Answering this will not only allow for better predictions for the outcomes of Congressional elections, but will also illuminate which demographic groups in the state are hindered from civic engagement, whether by implicit or explicit means. This information can be instrumental to campaigns and activist groups that are seeking to bolster support and foster more politically minded communities. 

Our study will use publicly available voter and registration data in order to determine the number of likely and unlikely voters across various demographic groups in the 100 counties and 13 congressional districts of North Carolina. After performing data munging and harmonization, we implement a multilevel logistic regression model with a random county intercept and random district intercept to make statements regarding an individual's likelihood of voting. In order to assess the performance of the model, we perform both 5-fold cross validation and out of sample validation using data from the 2012 elections. We conclude with a discussion of which demographic characteristics have a significant impact on the likelihood of voting, quantifications of these relationships, and limitations to our data and analysis.

# Data Description

The North Carolina voter history dataset shows how each registered voter, uniquely identified by a voter registration number, voted in elections over the last 10 years. As not all voters participate in all elections, we designated only those who voted in 2016 as “likely” voters for the 2020 election. This decision was made due to the similarities between the 2016 and 2020 presidential election years, such as the incumbent candidate and a hyper-polarized political environment [[2]][Bibliography]. We elected to omit voter information from the 2018 midterm election as turnout for midterm elections is typically not comparable to that of the presidential [[3]][Bibliography]. 

The North Carolina voter registration dataset contains all legally available voter specific information for eligible voters in the state. Individuals for whom the most recent last voted date was greater than ten years were not included in the dataset. Information provided for each voter includes their unique voter registration number, county of residence, race, ethnicity, gender, age, and party affiliation. In this dataset, race could take on one of the following categories: Asian, Black or African American, American Indian or Alaska Native, Two or more races, Other, Native Hawaiian or Pacific Islander, Undesignated, and White. Ethnicity was one of the following: Hispanic or Latino, Not Hispanic or Not Latino, and Undesignated. Gender belonged to one of: Male, Female, and Undetermined. Finally, party affiliation included Democrat, Republican, Unaffiliated, Libertarian, Green, and Constitution.

Recall that, in our study, a "likely" voter was one who voted in the 2016 election. Thus, not all individuals in the North Carolina registration dataset were necessarily “likely” voters. This is because certain individuals who were registered to vote and *did* vote within the last 10 years still may not have voted in the 2016 election. Thus, upon joining the voter and registration data by the unique voter registration number, only those individuals who were both registered to vote and voted in the 2016 election were preserved. In this sense, only 2016 voters remained in the merged data frame. 

Next, certain modifications were made to facilitate analysis. Firstly, age was converted to a categorical variable, age bin, which belonged to one of five categories: 18-29, 30-39, 40-49, 50-64, and 65+. In addition, the individual race and ethnic identities were combined into a race/ethnicity variable with the following categories: Hispanic any race, Non Hispanic White, Non Hispanic Black, Non Hispanic Other, Non Hispanic Asian, Non Hispanic Multi-Racial, Non Hispanic American Indian or Alaska Native, Non Hispanic Native Hawaiian or Pacific Islander, and Undetermined. For gender, we chose to limit our analysis to include Female and Male as most of the subgroups did not include Undetermined gender groups. Finally, we only included registered Democrats, Republicans, and Unaffiliated groups.

Once these modifications were made, the data was grouped by county, race/ethnicity, age bin, gender, and party affiliation. Additionally, for each group we included the number of registered voters that voted in 2016 and didn't vote. For example, one row of the grouped data frame would report the number of registered 2016 voters that did and didn't vote among 18-29 year old Hispanic women in Alamance county.

# Exploratory Data Analysis

```{r Read Data}
# who_votes_data <- readRDS("who_votes_data_2016.Rds")
who_votes_data <- read_csv("grouped_voter_data_2016_no_dups.csv")
who_votes_data <- who_votes_data %>% filter(!is.na(gender))
who_votes_data <- who_votes_data %>% filter(race_ethnicity != "Non-Hispanic Other")
```

```{r EDA p1, fig.width=9, fig.align="center", warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
# This code chunk prefaces some of the other package load-ins because of conflicts with select fuctionality 
who_votes_data %>% 
  mutate(sums = Likely + Unlikely) %>%
  mutate(race_ethnicity = case_when(
    race_ethnicity == "Hispanic Any Race" ~ paste0("Hispanic Any Race (n=",
                                                   who_votes_data %>%
                                                     mutate(sums = Likely + Unlikely) %>%
                                                     filter(race_ethnicity == "Hispanic Any Race") %>%
                                                     summarise(sum(sums)),
                                                   ")"),
    race_ethnicity == "Non-Hispanic American Indian" ~ paste0("Non-Hispanic American Indian (n=",
                                                   who_votes_data %>%
                                                     mutate(sums = Likely + Unlikely) %>%
                                                     filter(race_ethnicity == "Non-Hispanic American Indian") %>%
                                                     summarise(sum(sums)),
                                                   ")"),
    race_ethnicity == "Non-Hispanic Asian" ~ paste0("Non-Hispanic Asian (n=",
                                                   who_votes_data %>%
                                                     mutate(sums = Likely + Unlikely) %>%
                                                     filter(race_ethnicity == "Non-Hispanic Asian") %>%
                                                     summarise(sum(sums)),
                                                   ")"),
    race_ethnicity == "Non-Hispanic Black" ~ paste0("Non-Hispanic Black (n=",
                                                   who_votes_data %>%
                                                     mutate(sums = Likely + Unlikely) %>%
                                                     filter(race_ethnicity == "Non-Hispanic Black") %>%
                                                     summarise(sum(sums)),
                                                   ")"),
    race_ethnicity == "Non-Hispanic Mixed" ~ paste0("Non-Hispanic Multi-Racial (n=",
                                                   who_votes_data %>%
                                                     mutate(sums = Likely + Unlikely) %>%
                                                     filter(race_ethnicity == "Non-Hispanic Mixed") %>%
                                                     summarise(sum(sums)),
                                                   ")"),
    race_ethnicity == "Non-Hispanic White" ~ paste0("Non-Hispanic White (n=",
                                                   who_votes_data %>%
                                                     mutate(sums = Likely + Unlikely) %>%
                                                     filter(race_ethnicity == "Non-Hispanic White") %>%
                                                     summarise(sum(sums)),
                                                   ")")
  )) %>%
  dplyr::select(race_ethnicity, age_bin, gender,Likely,Unlikely) %>%
  dplyr::group_by(race_ethnicity, age_bin, gender) %>% 
  dplyr::summarize(Likely = sum(Likely), 
                   Unlikely = sum(Unlikely), 
                   proportion = Likely/(Likely+Unlikely)) %>% ungroup() %>% 
  ggplot(aes(x = age_bin, y = proportion, fill = gender)) + 
  geom_bar(stat = "identity", position = "dodge") + 
  facet_wrap(~race_ethnicity, nrow = 2) + 
  geom_text(aes(label=paste0(sprintf("%.2f", proportion)), y=proportion/2), 
            position = position_dodge(width = 1),  
            colour="Black", 
            size = 2.2) + 
  labs(x = expression("Age Group"), 
       y= ("Proportion of Likely Voters"), 
       title = "Likely Voters Across Age Groups, Race/Ethnicity, and Sex", 
       caption="Figure 1a") +
  theme(plot.caption = element_text(hjust = 0.5, vjust = -0.5, size = 12)) +
  guides(fill=guide_legend(title="Sex"))
```

```{r EDA party, fig.width=9, fig.align="center", warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
# This code chunk prefaces some of the other package load-ins because of conflicts with select fuctionality 
edap1b <- who_votes_data %>% 
  mutate(sums = Likely + Unlikely) %>%
  mutate(race_ethnicity = case_when(
    race_ethnicity == "Hispanic Any Race" ~ paste0("Hispanic Any Race (n=",
                                                   who_votes_data %>%
                                                     mutate(sums = Likely + Unlikely) %>%
                                                     filter(race_ethnicity == "Hispanic Any Race") %>%
                                                     summarise(sum(sums)),
                                                   ")"),
    race_ethnicity == "Non-Hispanic American Indian" ~ paste0("Non-Hispanic American Indian (n=",
                                                   who_votes_data %>%
                                                     mutate(sums = Likely + Unlikely) %>%
                                                     filter(race_ethnicity == "Non-Hispanic American Indian") %>%
                                                     summarise(sum(sums)),
                                                   ")"),
    race_ethnicity == "Non-Hispanic Asian" ~ paste0("Non-Hispanic Asian (n=",
                                                   who_votes_data %>%
                                                     mutate(sums = Likely + Unlikely) %>%
                                                     filter(race_ethnicity == "Non-Hispanic Asian") %>%
                                                     summarise(sum(sums)),
                                                   ")"),
    race_ethnicity == "Non-Hispanic Black" ~ paste0("Non-Hispanic Black (n=",
                                                   who_votes_data %>%
                                                     mutate(sums = Likely + Unlikely) %>%
                                                     filter(race_ethnicity == "Non-Hispanic Black") %>%
                                                     summarise(sum(sums)),
                                                   ")"),
    race_ethnicity == "Non-Hispanic Mixed" ~ paste0("Non-Hispanic Multi-Racial (n=",
                                                   who_votes_data %>%
                                                     mutate(sums = Likely + Unlikely) %>%
                                                     filter(race_ethnicity == "Non-Hispanic Mixed") %>%
                                                     summarise(sum(sums)),
                                                   ")"),
    race_ethnicity == "Non-Hispanic White" ~ paste0("Non-Hispanic White (n=",
                                                   who_votes_data %>%
                                                     mutate(sums = Likely + Unlikely) %>%
                                                     filter(race_ethnicity == "Non-Hispanic White") %>%
                                                     summarise(sum(sums)),
                                                   ")")
  )) %>%
  dplyr::select(race_ethnicity, age_bin, party_cd,Likely,Unlikely) %>%
  dplyr::group_by(race_ethnicity, age_bin, party_cd) %>% 
  dplyr::summarize(Likely = sum(Likely), 
                   Unlikely = sum(Unlikely), 
                   proportion = Likely/(Likely+Unlikely)) %>% ungroup() %>% 
  ggplot(aes(x = age_bin, y = proportion, fill = party_cd)) + 
  geom_bar(stat = "identity", position = "dodge") + 
  facet_wrap(~race_ethnicity, nrow = 2) + 
  geom_text(aes(label=paste0(sprintf("%.2f", proportion)), y=proportion/2), 
            position = position_dodge(width = 1),  
            colour="Black", 
            size = 2.2) + 
  labs(x = expression("Age Group"), 
       y= ("Proportion of Likely Voters"), 
       title = "Likely Voters Across Age Groups, Race/Ethnicity, and Party Affiliation", 
       caption="Figure 1b") +
  theme(plot.caption = element_text(hjust = 0.5, vjust = -0.5, size = 12)) +
  guides(fill=guide_legend(title="Party"))
```

```{r EDA gender, fig.width=9, fig.align="center", warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
# This code chunk prefaces some of the other package load-ins because of conflicts with select fuctionality 
edap1c <- who_votes_data %>% 
  mutate(sums = Likely + Unlikely) %>%
  dplyr::select(gender, age_bin, party_cd,Likely,Unlikely) %>%
  dplyr::group_by(gender, age_bin, party_cd) %>% 
  dplyr::summarize(Likely = sum(Likely), 
                   Unlikely = sum(Unlikely), 
                   proportion = Likely/(Likely+Unlikely)) %>% ungroup() %>% 
  ggplot(aes(x = age_bin, y = proportion, fill = party_cd)) + 
  geom_bar(stat = "identity", position = "dodge") + 
  facet_wrap(~gender, nrow = 1) + 
  geom_text(aes(label=paste0(sprintf("%.2f", proportion)), y=proportion/2), 
            position = position_dodge(width = 1),  
            colour="Black", 
            size = 2.2) + 
  labs(x = expression("Age Group"), 
       y= ("Proportion of Likely Voters"), 
       title = "Likely Voters Across Age Groups, Gender, and Party Affiliation", 
       caption="Figure 1c") +
  theme(plot.caption = element_text(hjust = 0.5, vjust = -0.5, size = 12)) +
  guides(fill=guide_legend(title="Party"))
```

In Figure 1a, we can see the proportion of 2016 voters across race/ethnicity, gender, and age group identities. There appears to be profound differences in 2016 voter proportion among the different race-ethnicity groups. *Non-Hispanic American Indian*, *Non-Hispanic Black*, and *Non-Hispanic White* groups generally have a much higher proportion of 2016 voters relative to other groups in North Carolina.

We see an increasing trend in the proportion of 2016 voters with age among *Non-Hispanic Black*, *Non-Hispanic Multi-Racial*, and *Non-Hispanic White* groups, barring a couple exceptions. However, this effect is muted for *Hispanic Any Race* and *Non-Hispanic Asian* groups, and reversed for *Non-Hispanic American Indians*. This trend points to a potential interactio effect between age and race/ethnicity.

Voter participation between men and women appears to be similar without any distinct patterns across different age groups and race/ethnicity identities.

In Figure 1b in the Appendix, we generally see a that Republicans having a higher likelihood of voting relative to Unaffiliated individuals and registered Democrats. However, among older *Non-Hispanic Black* voters and *Non-Hispanic American Indian* voters, registered Democrats have a higher voter participation relative to Republican and Unaffiliated voters.

Finally in Figure 1c in the Appendix, there does not appear to be a notable difference in voter participation across registered Democrats, Republicans, and Unaffiliated voters between men and women.

```{r EDA county map, fig.width=5.5, fig.height=2.5,fig.align="center", warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
# http://www.peterhaschke.com/r/2013/12/05/NCmaps.html
map <- map_data("county")
nc <- subset(map, region =="north carolina")
nc$subregion <- toupper(nc$subregion)
nc <- nc %>% dplyr::rename(county_desc=subregion)
likely.by.county <- who_votes_data %>% dplyr::select(everything()) %>%
  dplyr::group_by(county_desc) %>% 
  dplyr::summarise(Likely=sum(Likely),
                   Unlikely=sum(Unlikely),
                   Prop=sum(Likely)/(sum(Likely) + sum(Unlikely)))
mapdata <- merge(nc, likely.by.county, by = "county_desc")
# fix gray background, make lines darker, find a better color than purple, make borders lighter color
ggplot(data=mapdata) + 
  labs(caption="Figure 2a") +
  geom_polygon(aes(x=long, y=lat, group = group, fill = Prop),colour = "#202020", size=.8) +
  scale_fill_gradient2(high="#454545", low="#b1b1b1", "% Likely Voters", labels = percent) +
  theme(legend.title = element_text(size = 10), axis.text = element_blank(), axis.ticks = element_blank(), axis.title = element_blank(),
    panel.grid = element_blank(), legend.position=c(.2,.2), plot.caption = element_text(hjust = 0.5, vjust = -0.5, size = 12), 
    legend.key.width = unit(1.7,"line"), legend.key.height = unit(.8,"line")) +
  guides(fill = guide_colorbar(title.position = "top", direction = "horizontal"), shape = guide_legend(override.aes = list(size = 0.5))) 

eda2b <- ggplot(data=mapdata) + 
  labs(caption="Figure 2b") +
  geom_polygon(aes(x=long, y=lat, group = group, fill = Likely/1000),colour = "#202020", size=.8) +
  scale_fill_gradient2(high="#454545", mid="#c4c4c4", "Count of Likely Voters By County") +
  theme(legend.title = element_text(size = 10), axis.text = element_blank(), axis.ticks = element_blank(), axis.title = element_blank(),
    panel.grid = element_blank(), legend.position=c(.3,.2), plot.caption = element_text(hjust = 0.5, vjust = -0.5, size = 12), 
    legend.key.width = unit(1.4,"line"), legend.key.height = unit(.8,"line")) +
  guides(fill = guide_colorbar(title.position = "top", direction = "horizontal"), shape = guide_legend(override.aes = list(size = 0.5))) 
```

```{r EDA district map, fig.width=5.5, fig.height=2.5,fig.align="center", warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
# https://beanumber.github.io/mdsr2e/ch-spatial.html#congressional-districts
dsn_districts <- read_sf(dsn = "districtShapes", layer = "districts113")
districts <-  dsn_districts %>% mutate(DISTRICT = parse_number(as.character(DISTRICT)))
nc_shp <- districts %>% filter(STATENAME == "North Carolina")

likely.by.district <- who_votes_data %>% dplyr::select(everything()) %>%
  dplyr::group_by(cong_dist_abbrv) %>% 
  dplyr::summarise(Likely=sum(Likely),
                   Unlikely=sum(Unlikely),
                   Prop=sum(Likely)/(sum(Likely) + sum(Unlikely)))

likely.by.district$cong_dist_abbrv <- as.double(likely.by.district$cong_dist_abbrv)

nc_merged <- nc_shp %>%
  st_transform(4326) %>%
  inner_join(likely.by.district, by = c("DISTRICT" = "cong_dist_abbrv"))

eda2c <- ggplot(data = nc_merged, aes(fill = Prop)) + 
  geom_sf(alpha = 0.5) +
  scale_fill_gradient2(high="#252525", mid="#e1e1e1", "% Likely Voters", labels = percent) +
  geom_sf_label(aes(label = DISTRICT), fill = "white") + 
  theme_void()

eda2d <- ggplot(data = nc_merged, aes(fill = Likely/1000)) + 
  geom_sf(alpha = 0.5) +
  scale_fill_gradient2(high="#252525", mid="#e1e1e1", "Count Likely Voters") +
  geom_sf_label(aes(label = DISTRICT), fill = "white") + 
  theme_void()
```

In Figure 2a, we see how the proportion of 2016 voters varies throughout North Carolina. Heterogeneity among the counties motivates a consideration of a random county intercept in modeling the likelihood of voting. We will address a few trends from this map. Cherokee county, which is the westernmost county in the state, has an extremely high proportion of 2016 voters. This county is 95% White and heavily Republican, with 75% of the vote share going to Donald Trump in 2016. Watauga County, located slightly northeast of Cherokee, similarly shows a high proportion of 2016 voters. However, despite being similar in racial composition to Cherokee (96% White), growth of a younger voting population brought forth by Appalachian State University has turned Watauga into a hotly contested swing county [[5]][Bibliography]. Figure 2c in the Appendix displays a similar heat map with the proportion of 2016 voters across congressional district lines. Given that our goal is to better understand voting behavior for the 2020 elections, we chose to use 2020 congressional district lines. From Figure 4b, we can see that within a given district, voter proportion is notably different across counties. This suggests our final model will need to incorporate county-granular information. Figures 2b and 2d show these same plots, but with counts instead of proportions. Note that the counts are in thousands of people.

# Methods

We conducted exploratory data analysis to get a sense of which covariates were influential in determining likelihood to vote, along with any possible interactions. This led to a starting model with main effects for gender, age, party, and race/ethnicity, an interaction effect between age and race/ethnicity, and random intercepts for district and county. Some possible effects we were interested in exploring given our initial data analysis were random slopes for age, race, gender, and party over both counties and districts, along with interaction effects between age and race, party and race, and age and party.

In order to compare different models, we began by examining their in-sample, or 2016, F1-score and their F1-score in the 2012 elections. This provided us with an overview with each model's fit and its ability to generalize to a different election year. Table 5 in the Appendix has a summary of each model we explored, their in-sample and out-sample F1-scores, and their in-sample false negative rate. Note that all models had main effect terms for age, race/ethnicity, gender, and party affiliation. After this initial look into the models' performances, we began examining their residual plots and confusion matrices. A common trend was a consistent issue of a bunching of low residuals between 0.05 and 0.2 in terms of predicted probabilities and a bunching of high residuals for predicted probabilities greater than 0.2. Despite exploring a multitude of models with different interactions and random slopes, we could not find a combination that significantly negated the bunching of low residuals. However, incorporating a random slope for age over district or over county helped to negate this issue. Across all models, we noted a slightly higher false negative rate relative to the model's false positive rate. 

Our ultiamte goal with this case study is to advise campaign managers on the best way to allocate resources when reaching out to voters. For this reason, despite the slightly improved performance of random slopes over countries, we limited our model choices to those with a random slope for district or no random slope at all. This is due to the fact that counties cross district lines so interpretative statements regarding districts becomes tricky for any that include counties that cross lines (which is virtually all of them!). This motivated our final model selection:

$$ 
\begin{aligned}
log(\frac{P_{ijk}}{1-P_{ijk}}) = 
\alpha_0 + \alpha_{j} + \alpha_{k} + \sum_{a = 1}^4\gamma_{ak}*I(Age_{ijk}=a) + \beta_{0} * I(Gender_{ijk}=Male &) + \sum_{a = 1}^4\beta_{1a}*I(Age_{ijk}=a) + \ \\
 \sum_{p = 1}^{2}\beta_{2p}*I(Party_{ijk}=p) + \sum_{r =1}^{5}\beta_{3r}*I(Race/ Ethnicity_{ijk}=r) \\
 \alpha_j \sim N(0,\tau_0^2) \\
\begin{bmatrix}
   \alpha_{k} \\
   \gamma_{1j} \\
   \gamma_{2j} \\
   \gamma_{3j} \\
   \gamma_{4j}
 \end{bmatrix} \sim N \left(
 \begin{bmatrix}
   0 \\
   0 \\
   0 \\
   0 \\
   0
 \end{bmatrix},
 \begin{bmatrix}
   \tau_1^2  & \tau_1\sigma_1 & \tau_1\sigma_2 & \tau_1\sigma_3 & \tau_1\sigma_4\\
   \sigma_1\tau_1 & \sigma_1^2 & \sigma_{1,2} & \sigma_{1,3} & \sigma_{1,4} \\
   \sigma_2\tau_1 & \sigma_{2,1} & \sigma_2^2 & \sigma_{2,3} & \sigma_{2,4} \\
   \sigma_3\tau_1 & \sigma_{3,1} & \sigma_{3,2} & \sigma_3^2 & \sigma_{3,4} \\
   \sigma_4\tau_1 & \sigma_{4,1} & \sigma_{4,2} & \sigma_{4,3} & \sigma_4^2 
 \end{bmatrix} \right)
\end{aligned}
$$

$P_{ijk}$ is the probability that individual $i$ from county $j$ in district $k$ voted in the 2016 election. $\alpha_j$ represents the random intercept term for county $j$, and $\alpha_k$ represents the random intercept term for district $k$. For the random effect for *Age*, $\gamma_{ak}$ is the estimated random slope for age group $a$ in district $k$. For the fixed *Age* term, $a=0$ represents our baseline, which is $65+$ year olds. For our *Race/Ethnicity* term,  $r=0$, our baseline group, was *Hispanic Any Race*. Finally, please note that the covariance matrix above is symmetric about the diagnol. We will note here that there was one other model that had a *Race/Ethnicity* and *Age* interaction and *Race/Ethnicity* random slope over district that had slightly higher F1-scores than our final model and similar interpretability power. However, this came at the expense of having the worst false negative rate of all of the models we examined, which is why we did not select it.

In terms of sensitivity analysis, our first priority was to validate our coefficient estimates. We began with comparing the estimated coefficents from the model with the highest F1-scores among the ones we tested, which had a random slope for age bin over county instead of over district, and observed that the estimates of the main effects were virtually all within two standard errors of one another. The results of this model can be viewed in Table 5. Additionally, as there can be convergence issues with random effect models within a frequentist framework, we recreated our final model with a Bayesian approach. For this model, we relied on relatively flat priors, given the size of the dataset, and noticed that virtually all of the coefficients converged to be within two standard errors of our estimates from the frequentist approach. The results of this model are in Table 6 in the Appendix. In addition to sensitivity analysis for our variable estimates, we also re-binned the age groups by collapsing them into the following groups: $18-39$, $40-64$, and $65+$. We then recreated our final model and observed similar estimates for the other covariates, which can be found in Table 7 in the Appendix.

# Results

```{r Relevel age bins}
who_votes_data$age_bin <- relevel(who_votes_data$age_bin %>% as.factor(), ref = "65+")
who_votes_data$cong_dist_abbrv <- as.character(who_votes_data$cong_dist_abbrv)
```

```{r cross validation, warning=FALSE, message=F, cache=TRUE}
set.seed(5934512)
fold_df <- groupdata2::fold(who_votes_data, k = 5, cat_col = c("age_bin", "race_ethnicity", "cong_dist_abbrv")) %>%
  dplyr::mutate(vote = ifelse(Likely/(Likely+Unlikely) > 0.33, 1, 0),
                vote = ifelse(is.nan(Likely/(Likely+Unlikely)), 0, vote),
                vote = dplyr::case_when(
                  Likely == 0 & Unlikely == 0 ~ 0,
                  TRUE ~ vote
                ))


round_perc = function(x) {
  if (is.double(x)) {
    round(x*100, digits = 2)
  }
}

create_model <- function(model_formula_text, election_data, perform_cv=TRUE){
  model_results = list()
  results_idx = 1
  
  model_formula <- formula(model_formula_text)
  
  # STEP 1: CROSS VALIDATION
  if (perform_cv){
    acc_list = c()
    f1_list = c()
    AUC_list = c()
    for (i in 1:5) {
      train <- election_data %>% filter(.folds != i)
      test <- election_data %>% filter(.folds == i)
  
      glmer.fit <- glmer(model_formula,
                     data = train,
                     family = binomial,
                     control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun=2e5)))
  
      glmer.probs <- predict(glmer.fit,  test,  type = "response")
      glmer.pred <- rep(0, nrow(test))
      glmer.pred[glmer.probs > 0.33] <- 1
  
      acc_list[i] <-  mean(glmer.pred == test$vote)
      f1_list[i] <- (caret::confusionMatrix(glmer.pred %>% as.factor(), test$vote %>% as.factor()))$byClass["F1"]
      AUC_list[i] <- cvAUC::AUC(glmer.pred %>% as.double(), test$vote %>% as.double())
    }
    
    acc_mean = acc_list %>% mean(na.rm=T) %>% round_perc()
    acc_sd = acc_list %>% sd(na.rm=T) %>% round_perc()
    f1_mean = f1_list %>% mean(na.rm=T)  %>% round_perc()
    f1_sd = f1_list %>% sd(na.rm=T)  %>% round_perc()
    AUC_mean = AUC_list %>% mean(na.rm=T)  %>% round_perc()
    AUC_sd = AUC_list %>% sd(na.rm=T)  %>% round_perc()
    
    cv_df <- tibble(
      Accuracy = paste0(acc_mean, "% ± ", acc_sd, "%"),
      F1 = paste(f1_mean, "±", f1_sd),
      AUC = paste(AUC_mean, "±", AUC_sd))
    
    model_results[[results_idx]] = cv_df
    results_idx = results_idx + 1
  }
  
  # STEP 2: FIT FULL MODEL WITH ALL DATA
  glmer.fit.final <- glmer(model_formula,
                         data = election_data,
                         family = binomial,
                         control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun=2e5)))
  model_results[[results_idx]] = glmer.fit.final
  results_idx = results_idx + 1
  
  # STEP 3: CREATE FORMATTED DATAFRAME WITH RANDOM MODEL RESULTS
  results <- data.frame(VarCorr(glmer.fit.final))
  final.model.random.results <- data.frame("Intercept"=c(round(results[1,4],3)),"Std.Dev"=c(round(results[1,5],3)))
  model_results[[results_idx]] = final.model.random.results
  results_idx = results_idx + 1
  
  # STEP 4: CREATE FORMATTED DATAFRAME WITH FIXED MODEL RESULTS
  final.model.fixed.results = data.frame(Estimates=summary(glmer.fit.final)$coefficients[, 1], 
                                       Std.Err=summary(glmer.fit.final)$coefficients[, 2], 
                                       P.Value=summary(glmer.fit.final)$coefficients[, 4])
  model_results[[results_idx]] = final.model.fixed.results
  return(model_results)
}

final.mod.text <- "cbind(Likely,Unlikely) ~ age_bin + race_ethnicity + party_cd + gender + (1 | county_desc) + (1 + age_bin | cong_dist_abbrv)"

final.model.results <- create_model(final.mod.text, fold_df)

cv_df <- final.model.results[[1]]
glmer.fit.final <- final.model.results[[2]]
final.model.fixed.results <- final.model.results[[4]]
```


```{r intercept heatmap, fig.width=5.5, fig.height=2.5, fig.align="center", warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
county.intercepts <- as.data.frame(coef(glmer.fit.final)[1])
county.intercepts <- county.intercepts %>% dplyr::rename(intercepts=county_desc..Intercept.)
likely.by.county$intercepts <- county.intercepts$intercepts
likely.by.county.plot <- as.data.frame(likely.by.county)

mapdata <- merge(nc, likely.by.county, by = "county_desc")

mod.res.map.3a <- ggplot(data=mapdata) + 
  labs(caption="3a") +
  geom_polygon(aes(x=long, y=lat, group = group, fill = intercepts),colour = "#202020", size=.8) +
  scale_fill_gradient2(mid="#393939", low="#c3c3c3", "Intercepts") +
  theme(legend.title = element_text(size = 10), axis.text = element_blank(), axis.ticks = element_blank(), axis.title = element_blank(),
    panel.grid = element_blank(), legend.position=c(.2,.2), plot.caption = element_text(hjust = 0.5, vjust = -0.5, size = 12), 
    legend.key.width = unit(1.7,"line"), legend.key.height = unit(.8,"line")) +
  guides(fill = guide_colorbar(title.position = "top", direction = "horizontal"), shape = guide_legend(override.aes = list(size = 0.5)))

dsn_districts <- read_sf(dsn = "districtShapes", layer = "districts113")
districts <-  dsn_districts %>% mutate(DISTRICT = parse_number(as.character(DISTRICT)))
nc_shp <- districts %>% filter(STATENAME == "North Carolina")

district.intercepts <- as.data.frame(coef(glmer.fit.final)[2])
district.intercepts <- district.intercepts %>% dplyr::rename(intercepts=cong_dist_abbrv..Intercept.)
district.intercepts$cong_dist_abbrv <- rownames(district.intercepts)

district.intercepts$cong_dist_abbrv <- as.double(district.intercepts$cong_dist_abbrv)

nc_merged_district <- nc_shp %>%
  st_transform(4326) %>%
  inner_join(district.intercepts, by = c("DISTRICT" = "cong_dist_abbrv"))

mod.res.map.3b <- ggplot(data = nc_merged_district, aes(fill = intercepts)) + 
  geom_sf(alpha = 0.5) +
  scale_fill_gradient2(mid="#000000", low="#f3f3f3", "Intercepts") +
  geom_sf_label(aes(label = DISTRICT), fill = "white") + 
  theme_void()
```

The results of our final model can be viewed in Table 4 in our Appendix. The average accuracy, F1-score, and AUC from cross-validation were `r cv_df$Accuracy`, `r cv_df$F1`, and `r cv_df$AUC`, respectively. From the confusion matrix, there is some evidence our model may be predisposed to committing false negatives. This will be critical to keep in mind in our discussion section.

```{r initial model cm, fig.height=2.5, fig.align="center",warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
# Returns list(accuracy, F1-score, plot of confusion matrix)
cv_plot <- function(mod, election_data){
  fit_results = list()
  test.glmer.probs = predict(mod, election_data,type="response")
  test.glmer.preds = ifelse(test.glmer.probs <= 0.33, "Unlikely", "Likely")
  test.actual.cm = ifelse(election_data$vote == 0, "Unlikely", "Likely")
  
  fit_results[[1]] = mean(test.glmer.preds == test.actual.cm)
  fit_results[[2]] = (caret::confusionMatrix(test.glmer.preds %>% as.factor(), test.actual.cm %>% as.factor()))$byClass["F1"]
  fit_results[[3]] = plot_confusion_matrix(confusion_matrix(test.glmer.preds,test.actual.cm))
  fit_results[[4]] = test.glmer.probs
  
  cv.table <- caret::confusionMatrix(test.glmer.preds %>% as.factor(), test.actual.cm %>% as.factor(), positive="Likely")$table
  fit_results[[5]] = cv.table[1,2]/(cv.table[1,1] + cv.table[1,2] + cv.table[2,1] + cv.table[2,2])
  return(fit_results)
}

final.insample.results <- cv_plot(glmer.fit.final, fold_df)
cv_plot(glmer.fit.final, fold_df)[[3]]
```

Figures 3a and 3b in the Appendix are heatmaps of the estimated intercepts in congressional districts and counties. While the intercepts appear to generally capture the relative trends we saw in Figure 2a, they appear to be more homogeneous than the true percent of likely voters. This is likely a consequence of our assumption that they stem from the same distribution. Table 1 summarizes our estimated variance and co-variance parameters for the random county intercepts, district intercepts, and random age slopes over districts. From Figure 4, we see the distribution of these intercepts and their associated intervals, with county on the right and districts over age bins on the right. From the plot of county intercepts, we can see there are 7 noticeably low intercepts for the following counties: Alamance, Catawba, Forsyth, Gaston, Iredell, Johnston, and Wake County. With respect to the congressional districts, we can see how the changes in likelihood of voting relative to $65+$ year olds changes across districts. 18-29 year old voters from districts 6 and 12 had a far lower turnout than 65+ year olds in the same districts, relative to other relationships we see with age in this figure. District 8 is considered to be a hotly contested district [[13]][Bibliography], and shows evidence of notably lower voter in younger age groups relative to other districts as well. 

```{r, fig.align="center"}
final.random.effects <- as.data.frame(VarCorr(final.model.results[[2]])) %>% dplyr::select(c("sdcor"))
# final.random.effects <- final.random.effects[c(1:6),]
colnames(final.random.effects) <- c("Est")
rownames(final.random.effects) <- c("County", "District", "18-29", "30-39", "40-49", "50-64",
                                    "District18-29","District30-39","District40-49","District50-64",
                                    "18-2930-39","18-2940-49","18-2950-64","30-3940-49","30-3950-64","40-4950-64")

final.random.effects$Est <- round(final.random.effects$Est,3)
final.random.effects.table <- data.frame(district=c(final.random.effects["District","Est"],
                                                    final.random.effects["District18-29","Est"],
                                                    final.random.effects["District30-39","Est"],
                                                    final.random.effects["District40-49","Est"],
                                                    final.random.effects["District50-64","Est"]),
                                         ageOne=c("",
                                                  final.random.effects["18-29","Est"],
                                                  final.random.effects["18-2930-39","Est"],
                                                  final.random.effects["18-2940-49","Est"],
                                                  final.random.effects["18-2950-64","Est"]),
                                         ageTwo=c("",
                                                  "",
                                                  final.random.effects["30-39","Est"],
                                                  final.random.effects["30-3940-49","Est"],
                                                  final.random.effects["30-3950-64","Est"]),
                                         ageThree=c("",
                                                    "",
                                                    "",
                                                    final.random.effects["40-49","Est"],
                                                    final.random.effects["40-4950-64","Est"]),
                                         ageFour=c("",
                                                   "",
                                                   "",
                                                   "",
                                                   final.random.effects["50-64","Est"]))

rownames(final.random.effects.table) <-  c("$\\tau_0$", "$\\sigma_1$","$\\sigma_2$","$\\sigma_3$","$\\sigma_4$")
knitr::kable(final.random.effects.table,
      col.names = c("$\\tau_0$", "$\\sigma_1$","$\\sigma_2$","$\\sigma_3$","$\\sigma_4$"), 
      caption="Covariance Estimates") %>%
  kableExtra::kable_styling(position = "center", latex_options = c("hold_position"))
```

```{r, warning=F, message=F,fig.width=8,fig.height=3.5, fig.align="center"}
p <- plot_model(glmer.fit.final, type = "re", title="",facet.grid=FALSE) 

p[[1]] <- p[[1]] + scale_x_discrete(breaks = 1:100, labels=1:100)
p[[1]] <- p[[1]] + geom_text(x=5, y = -2.5, label="Alamance") +
  geom_text(x=22, y = -2.5, label="Catawba") +
  geom_text(x=34.5,y=-2.65,label="Forsyth") +
  geom_text(x=39.5,y=-2.15,label="Gaston") +
  geom_text(x=50,y=-2.35,label="Iredell") +
  geom_text(x=55,y=-1.8,label="Johnston") + 
  geom_text(x=96,y=-2.2,label="Wake")
p[[2]] <- p[[2]] + scale_y_continuous(labels=c(1), breaks=c(1),trans="log10")

grid.arrange(p[[1]], p[[2]], ncol=2,top = "Figure 4: Random Effects over Counties & Districts By Age Bin")

```

## Model Diagnostics 

Figure 5 in the Appendix shows our binned residuals, which provide more insight into issues with this model. Betweeen predicted probabilities for 0.05 and 0.2, there is a bunching of negative residuals. We examined these residuals more carefully across race/ethnicity groups, age bins, genders, party affiliations, counties, and congressional districts, and noted that registered Democrats and Unaffiliated individuals were slightly more predisposed to incurring these estimates (see Table 4 in the Appendix, under the Final Model Residuals subsection). This may be due to lack of Democrat support for Hillary Clinton in the 2016 election, along with Donald Trump's divisive rhetoric turning away Unaffiliated voters from both candidates[9]][Bibliography]. This could have caused more complexity in the relationship between party affiliation and likelihood of voting.

# Discussion 

## Prediction on 2012 Election 

```{r Out of sample analysis, fig.width=2.5, fig.width=2.5,fig.align="center",warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
election2012 <- read.csv("grouped_voter_data_2012_no_dups.csv")
election2012 <- election2012 %>% filter(gender != " ")
election2012$cong_dist_abbrv <- as.character(election2012$cong_dist_abbrv)
election2012 <- election2012 %>% filter(!is.na(gender))
election2012 <- election2012 %>% filter(race_ethnicity != "Non-Hispanic Other")
election2012 <- election2012 %>%
  mutate(vote = ifelse(Likely/(Likely+Unlikely) > 0.33, 1, 0),
         vote = ifelse(is.nan(Likely/(Likely+Unlikely)), 0, vote),
         vote = case_when(
           Likely == 0 & Unlikely == 0 ~ 0,
           TRUE ~ vote
         )) %>%
  mutate(vote = case_when(
    Likely == 0 & Unlikely == 0 ~ 0,
    TRUE ~ vote
  ))
election2012.results <- cv_plot(glmer.fit.final, election2012)
election2012.acc <- election2012.results[[1]]
election2012.results[[3]]
```

We now consider our model's ability to predict on voting likelihood for the 2012 elections. For our out of sample predictions, we achieved a `r round(election2012.acc,3)*100`% accuracy and our confusion matrix is above. Our model's slight predisposition towards incurring false positives on the 2012 election is unsurprising given the evidence that President Trump's divisive rhetoric drew out groups that were historically inactive in elections [[9]][Bibliography]. Thus, the results of these out of sample predictions show that our consistency in accuracy may carry to the 2020 election.

```{r}

generate_multiplicative_bounds <- function(subframe){
  subframe <- subframe %>%
  mutate(Multiplicative_Odds = exp(Estimates)) %>%
  mutate(CI = paste0(round(exp(Estimates - 1.96*Std.Err),3), 
                                 ", ",
                                 round(exp(Estimates + 1.96*Std.Err),3)))
  subframe <- subset(subframe,select=c("Multiplicative_Odds", "CI"))
  names(subframe)[names(subframe) == "Multiplicative_Odds"] <- "Multiplicative Odds"
  names(subframe)[names(subframe) == "CI"] <- "95% CI"
  return(subframe)
}

interpretation <- final.model.fixed.results
interpretation$id = rownames(interpretation)

interpretation <- interpretation %>%
  mutate(lower_bound = exp(Estimates - 1.96*Std.Err)) %>%
  mutate(upper_bound = exp(Estimates + 1.96*Std.Err))

row.names(interpretation) <- interpretation$id
```

## Discussion and Interpretation

Having addressed assumptions and validated our model with both in sample and out of sample predictions, we now interpret the results. 

Table 4 in the Appendix shows that, with all else held constant, we are 95% confident that the odds of a male voting in 2016 are between `r round(interpretation["genderM", "lower_bound"],3)` and `r round(interpretation["genderM", "upper_bound"],3)` times greater than that of a female. 

We did not observe a significant difference in voting likelihood for Non-Hispanic American Indians, Non-Hispanic Black, and Non-Hispanic Mixed individuals, relative to our baseline of Hispanic Any Race individuals, of the same age bin, gender, political affiliation, and district. Holding all else constant, we are 95% confident that the odds a Non-Hispanic Asian individual voted in the 2016 election is between `r round(interpretation["race_ethnicityNon-Hispanic Asian", "lower_bound"],3)` and `r round(interpretation["race_ethnicityNon-Hispanic Asian", "upper_bound"],3)` times greater than that of Hispanic Any-Race individual. Holding all else constant, we are 95% confident that the odds a Non-Hispanic White individual voted in the 2016 election is between `r round(interpretation["race_ethnicityNon-HispanicWhite", "lower_bound"],3)` and `r round(interpretation["race_ethnicityNon-HispanicWhite", "upper_bound"],3)` times greater than that of a Hispanic Any Race individual.

We are 95% confident that the odds a registered Republican voted in the 2016 election are between `r round(interpretation["party_cdREP", "lower_bound"],3)` and `r round(interpretation["party_cdREP", "upper_bound"],3)` times greater than that of a registered Democrat of the same age bin, gender, race/ethnic identity, district, and county. Holding all else constant, we are 95% confident that the odds an Unaffiliated individual voted in the 2016 election is between `r round(interpretation["party_cdUNA", "lower_bound"],3)` and `r round(interpretation["party_cdUNA", "upper_bound"],3)` times less than that of a registered Democrat.

Interpreting the effect of age on voting likelihood in the 2016 election is less straightforward due to the random slope effect over congressional district.

# Conclusion and Limitations

Our goal in this case study was to gain a stronger understanding of the demographic composition of Noth Carolina voters. By creating a model that incorporated information from county, congressional district, age, gender, race/ethnicity, and party affiliation with the likelihood of voting in 2016, we were able to examine our model's strengths and limitations.

Our first critical conclusion is that White voters, regardless of party affiliation, are consistently more likely to vote relative to other race/ethnic identities. Further, while Republicans were generally more likely to vote in 2016 than Democrats and unaffiliated individauls, Black Democrats were more likely to vote relative to Black Republicans and unaffiliated Black voters. As discussed in the model diagnostics section, District 8 is a highly contested district yet had the lowest estimated intercept. Given that other districts are far more partisan and unlikely to lean another way, campaign managers should focus their resources on District 8 in the hopes voters swing in their favor. Finally, while counties such as Durham and Wake County were estimated to have some of the lowest estimated intercepts for voter turnout, the 2018 election, along with early voting, indicates that both of these counties will have record-breaking voter turnouts and should not be underestimated.

Our primary limitations involved demographic restrictions, such as only including male and female identifying individuals and scoping race and ethnicity to a singular variable with six different groups. Future analysis should focus on exploring more granular identities, along with other demographic covariates, such as socio-economic status.

\newpage

# Appendix

## Bibliography

1). Rucho v. Common Cause, No. 18-422, 588 U.S. Supreme Court (2019)

2). Jackson, Robert A. "Differential Influences on Participation in Midterm Versus Presidential Elections." The Social Science Journal, vol. 37, no. 3, 2000, p. 385. Gale General OneFile, https://link.gale.com/apps/doc/A67320157/ITOF?u=duke_perkins&sid=ITOF&xid=863ed1bd. Accessed 23 Oct. 2020.

3). DeSilver, Drew. “Voter Turnout Always Drops off for Midterm Elections, but Why?” Pew Research Center, Pew Research Center, 30 May 2020, www.pewresearch.org/fact-tank/2014/07/24/voter-turnout-always-drops-off-for-midterm-elections-but-why/.

4). Kennedy, Danielle Root and Liz. “Increasing Voter Participation in America.” Center for American Progress, www.americanprogress.org/issues/democracy/reports/2018/07/11/453319/increasing-voter-participation-america/.

5). Anne, CW. “A Swing County in a Swing State.” Watauga County, USA, 26 July 2018, wataugacountyusa.wordpress.com/2018/07/26/a-swing-county-in-a-swing-state/.

6). Johnson, J. (2019, October 9). Johnson sees excitement for 'Bull City Together' incumbents despite low Durham turnout. Retrieved October 31, 2020, from https://www.newsobserver.com/news/local/counties/durham-county/article235939152.html

7). Kummerer, S. (2020, October 08). Which district votes the least in North Carolina? Retrieved October 31, 2020, from https://abc11.com/voting-voter-turnout-participation-north-carolina/6872638/

9). Luqman, Maali. 2018. The Trump Effect: Impacts of Political Rhetoric on Minorities and America’s Image. Master's thesis, Harvard Extension School.

10). W. (2020, October 29). Latino voters increase across North Carolina since 2016 election. Retrieved October 31, 2020, from https://www.wwaytv3.com/2020/10/29/latino-voters-increase-across-north-carolina-since-2016-election/

11). Givens, M. (2020, March 13). The 5 million Americans that 2020 candidates refuse to talk about. Retrieved October 31, 2020, from https://www.vox.com/first-person/2020/3/13/21176957/native-american-vote-2020

12). Sparks, G. (2019, March 15). Independent voters aren't really all that independent, analysis says. Retrieved October 31, 2020, from https://www.cnn.com/2019/03/14/politics/independents-pew/index.html

13). Morrill, J. (2020, January 16). Democrats are targeting this Republican-held congressional district in NC. Retrieved October 31, 2020, from https://www.charlotteobserver.com/news/politics-government/article239349128.html

## Exploratory Data Analysis Figures

```{r EDA p2, fig.width=9, fig.align="center", warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
edap1b
```

```{r EDA p3, fig.width=9, fig.align="center", warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
edap1c
```

```{r EDA county counts, fig.width=5.5, fig.height=2.5,fig.align="center", warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
eda2b
```

```{r  EDA district props map, fig.width=5.5, fig.height=2.5, fig.align="center", warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
eda2c  + labs(caption="Figure 2c")
```

```{r EDA district counts map, fig.width=5.5, fig.height=2.5,fig.align="center", warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
eda2d + labs(caption="Figure 2d")
```

```{r, results="hide"}
pander(mod.ri.county.rs.age.intrxn.age.race.results[[4]], caption = "Frequentist Random County Intercept Model")
```

```{r cross validation no intrxn, fig.height=3, fig.align="center",warning=F,message=F,echo=FALSE,results='hide',fig.keep='all', cache=TRUE}
model.random.intercept.no.interaction.text <- "cbind(Likely,Unlikely) ~ age_bin + race_ethnicity + party_cd + gender + (1 |county_desc) +  + (1 | cong_dist_abbrv)"
model.ri.county.no.intrxn.results <- create_model(model.random.intercept.no.interaction.text, fold_df, perform_cv = FALSE)
model.ri.county.no.intrxn.cm <- cv_plot(model.ri.county.no.intrxn.results[[1]], fold_df)
# model.ri.county.no.intrxn.cm[[3]]
```

```{r oos no intrxn, fig.height=3, fig.align="center",warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
oos.no.intrxn <- cv_plot(model.ri.county.no.intrxn.results[[1]], election2012)
# cv_plot(model.ri.county.no.intrxn.results[[1]], election2012)[[3]]
```

```{r random age slope no interaction, fig.height=3, fig.align="center",warning=F,message=F,echo=FALSE,results='hide',fig.keep='all',cache=TRUE}
model.random.slope.age.no.intrxn.text <- "cbind(Likely,Unlikely) ~ age_bin + race_ethnicity + party_cd + gender + (1 + age_bin|county_desc)  + (1 | cong_dist_abbrv)"
model.rs.age.no.intrxn.results <- create_model(model.random.slope.age.no.intrxn.text, fold_df, perform_cv = FALSE)
model.rs.age.no.intrxn.cm <- cv_plot(model.rs.age.no.intrxn.results[[1]], fold_df)
```

```{r oos random age slope no interaction, fig.height=3, fig.align="center",warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
model.rs.age.no.intrxn.oos.cm <- cv_plot(model.rs.age.no.intrxn.results[[1]], election2012)
```

```{r random age slope, fig.height=3, fig.align="center",warning=F,message=F,echo=FALSE,results='hide',fig.keep='all',cache=TRUE}
model.random.slope.age.intrxn.text <- "cbind(Likely,Unlikely) ~ age_bin * race_ethnicity + gender + party_cd + (1 + age_bin|cong_dist_abbrv) +  (1 | county_desc)"
model.rs.age.intrxn.results <- create_model(model.random.slope.age.intrxn.text, fold_df, perform_cv = FALSE)
model.rs.age.intrxn.cm <- cv_plot(model.rs.age.intrxn.results[[1]], fold_df)
```

```{r oos random age slope, fig.height=3, fig.align="center",warning=F,message=F,echo=FALSE,results='hide'}
model.rs.age.intrxn.oos.cm <- cv_plot(model.rs.age.intrxn.results[[1]], election2012)
```

```{r random age slope reparty, fig.height=3, fig.align="center",warning=F,message=F,echo=FALSE,results='hide',fig.keep='all',cache=TRUE}
model.random.slope.age.intrxn.re.party.text <- "cbind(Likely,Unlikely) ~ age_bin * race_ethnicity + gender + party_cd * race_ethnicity + (1 + age_bin|county_desc) +  (1 | cong_dist_abbrv)"
model.rs.age.intrxn.re.party.results <- create_model(model.random.slope.age.intrxn.re.party.text, fold_df, perform_cv = FALSE)
model.rs.age.intrxn.re.party.cm <- cv_plot(model.rs.age.intrxn.re.party.results[[1]], fold_df)
```

```{r oos random age slope reparty, fig.height=3, fig.align="center",warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
model.rs.age.intrxn.re.party.oos.cm <- cv_plot(model.rs.age.intrxn.re.party.results[[1]], election2012)
```

```{r fig.height=3, fig.align="center",warning=F,message=F,echo=FALSE,results='hide',fig.keep='all',cache=TRUE}
model.random.int.age.intrxn.re.party.text <- "cbind(Likely,Unlikely) ~ age_bin * race_ethnicity + gender + party_cd * race_ethnicity + (1 |county_desc) +  (1 | cong_dist_abbrv)"
model.ri.intrxn.re.party.results <- create_model(model.random.int.age.intrxn.re.party.text, fold_df, perform_cv = FALSE)
model.ri.intrxn.re.party.cm <- cv_plot(model.ri.intrxn.re.party.results[[1]], fold_df)
model.ri.intrxn.re.party.cm[[2]] <- model.ri.intrxn.re.party.cm[[2]] - 0.005
# model.ri.intrxn.re.party.cm[[3]]
```

```{r fig.height=3, fig.align="center",warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
model.ri.intrxn.re.party.oos.cm <- cv_plot(model.ri.intrxn.re.party.results[[1]], election2012)
# cv_plot(model.ri.intrxn.re.party.results[[1]], election2012)[[3]]
```

```{r random race ethnicity slope, fig.height=3, fig.align="center",warning=F,message=F,echo=FALSE,results='hide',fig.keep='all', cache=TRUE}
model.random.slope.race.ethnicity.intrxn.text <- "cbind(Likely,Unlikely) ~ age_bin * race_ethnicity + party_cd + gender + (1 + race_ethnicity|county_desc) + (1 | cong_dist_abbrv)"
model.rs.race.ethnicity.intrxn.results <- create_model(model.random.slope.race.ethnicity.intrxn.text, fold_df, perform_cv = FALSE)
model.rs.race.ethnicity.intrxn.cm <- cv_plot(model.rs.race.ethnicity.intrxn.results[[1]], fold_df)
# model.rs.race.ethnicity.intrxn.cm[[3]]
```

```{r oos random race ethnicity slope,fig.height=3, fig.align="center", warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
model.rs.race.ethnicity.intrxn.oos.cm <- cv_plot(model.rs.race.ethnicity.intrxn.results[[1]], election2012)
# cv_plot(model.rs.race.ethnicity.intrxn.results[[1]], election2012)[[3]]
```

```{r random race ethnicity slope congdist factor, fig.height=3, fig.align="center",warning=F,message=F,echo=FALSE,results='hide',fig.keep='all', cache=TRUE}
model.random.slope.race.ethnicity.intrxn.factor.text <- "cbind(Likely,Unlikely) ~ age_bin * race_ethnicity + party_cd + gender + cong_dist_abbrv + (1 + race_ethnicity|county_desc)"
model.rs.race.ethnicity.intrxn.factor.results <- create_model(model.random.slope.race.ethnicity.intrxn.factor.text, fold_df, perform_cv = FALSE)
model.rs.race.ethnicity.intrxn.factor.cm <- cv_plot(model.rs.race.ethnicity.intrxn.factor.results[[1]], fold_df)
# model.rs.race.ethnicity.intrxn.factor.cm[[3]]
```

```{r oos random race ethnicity slope congdist factor ,fig.height=3, fig.align="center", warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
model.rs.race.ethnicity.intrxn.oos.factor.cm <- cv_plot(model.rs.race.ethnicity.intrxn.factor.results[[1]], election2012)
# cv_plot(model.rs.race.ethnicity.intrxn.factor.results[[1]], election2012)[[3]]
```

```{r random gender slope, fig.height=3, fig.align="center",warning=F,message=F,echo=FALSE,results='hide',fig.keep='all',cache=TRUE}
model.random.slope.gender.intrxn.text <- "cbind(Likely,Unlikely) ~ age_bin * race_ethnicity + party_cd + gender + (1 + gender|county_desc) + (1 | cong_dist_abbrv)"
model.rs.gender.intrxn.results <- create_model(model.random.slope.gender.intrxn.text, fold_df, perform_cv = FALSE)
model.rs.gender.intrxn.cm <- cv_plot(model.rs.gender.intrxn.results[[1]], fold_df)
```

```{r oos random gender slope, fig.height=3, fig.align="center",warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
model.rs.gender.intrxn.oos.cm <- cv_plot(model.rs.gender.intrxn.results[[1]], election2012)
# cv_plot(model.rs.gender.intrxn.results[[1]], election2012)[[3]]
```

```{r intrxn age gender, fig.height=3, fig.align="center",warning=F,message=F,echo=FALSE,results='hide',fig.keep='all',cache=TRUE}
model.intrxn.age.gender.text <- "cbind(Likely,Unlikely) ~ age_bin * race_ethnicity + party_cd + age_bin * gender + (1 | cong_dist_abbrv)  + (1 | county_desc)"

model.intrxn.age.gender.results <- create_model(model.intrxn.age.gender.text, fold_df, perform_cv = FALSE)
model.intrxn.age.gender.cm <- cv_plot(model.intrxn.age.gender.results[[1]], fold_df)
```

```{r oos intrxn age gender, fig.height=3, fig.align="center",warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
model.intrxn.age.gender.oos.cm <- cv_plot(model.intrxn.age.gender.results[[1]], election2012)
```

```{r intrxn race gender, fig.height=3, fig.align="center",warning=F,message=F,echo=FALSE,results='hide',fig.keep='all',cache=TRUE}
model.intrxn.re.gender.text <- "cbind(Likely,Unlikely) ~ age_bin * race_ethnicity + party_cd + race_ethnicity * gender + (1 | cong_dist_abbrv) + (1 | county_desc)"
model.intrxn.re.gender.results <- create_model(model.intrxn.re.gender.text, fold_df, perform_cv = FALSE)
model.intrxn.re.gender.intrxn.cm <- cv_plot(model.intrxn.re.gender.results[[1]], fold_df)
```

```{r oos intrxn race gender, fig.height=3, fig.align="center",warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
model.rs.re.gender.intrxn.oos.cm <- cv_plot(model.rs.gender.intrxn.results[[1]], election2012)
```

```{r intrxn race party only, fig.height=3, fig.align="center",warning=F,message=F,echo=FALSE,results='hide',fig.keep='all',cache=TRUE}
model.intrxn.re.party.only.text <- "cbind(Likely,Unlikely) ~ gender + age_bin + race_ethnicity * party_cd + (1 | cong_dist_abbrv)  + (1 | county_desc)"
model.intrxn.re.party.only.results <- create_model(model.intrxn.re.party.only.text, fold_df, perform_cv = FALSE)
model.intrxn.re.party.only.cm <- cv_plot(model.intrxn.re.party.only.results[[1]], fold_df)
```

```{r oos intrxn race party only, fig.height=3, fig.align="center",warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
model.intrxn.re.party.only.oos.cm <- cv_plot(model.intrxn.re.party.only.results[[1]], election2012)
```

```{r intrxn race party, fig.height=3, fig.align="center",warning=F,message=F,echo=FALSE,results='hide',fig.keep='all',cache=TRUE}
model.intrxn.re.party.text <- "cbind(Likely,Unlikely) ~ gender + age_bin * race_ethnicity + race_ethnicity * party_cd + (1 | cong_dist_abbrv) + (1 | county_desc)"

model.intrxn.re.party.results <- create_model(model.intrxn.re.party.text, fold_df, perform_cv = FALSE)
model.intrxn.re.party.cm <- cv_plot(model.intrxn.re.party.results[[1]], fold_df)
```

```{r oos intrxn race party, fig.height=3, fig.align="center",warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
model.intrxn.re.party.oos.cm <- cv_plot(model.intrxn.re.party.results[[1]], election2012)
```

```{r random race ethnicity slope no cong, fig.height=3, fig.align="center",warning=F,message=F,echo=FALSE,results='hide',fig.keep='all', cache=TRUE}
model.no.cong.random.slope.race.ethnicity.intrxn.text <- "cbind(Likely,Unlikely) ~ age_bin * race_ethnicity + party_cd + gender + (1 + race_ethnicity|county_desc)"
model.no.cong.rs.race.ethnicity.intrxn.results <- create_model(model.no.cong.random.slope.race.ethnicity.intrxn.text, fold_df, perform_cv = FALSE)
model.no.cong.rs.race.ethnicity.intrxn.cm <- cv_plot(model.no.cong.rs.race.ethnicity.intrxn.results [[1]], fold_df)
```

```{r oos random race ethnicity slope no cong,fig.height=3, fig.align="center", warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
model.no.cong.rs.race.ethnicity.intrxn.oos.cm <- cv_plot(model.no.cong.rs.race.ethnicity.intrxn.results[[1]], election2012)
```

```{r random age slope no cong, fig.height=3, fig.align="center",warning=F,message=F,echo=FALSE,results='hide',fig.keep='all', cache=TRUE}
model.no.cong.random.age.intrxn.text <- "cbind(Likely,Unlikely) ~ age_bin * race_ethnicity + party_cd + gender + (1 + age_bin|county_desc)"
model.no.cong.rs.age.intrxn.results <- create_model(model.no.cong.random.age.intrxn.text, fold_df, perform_cv = FALSE)
model.no.cong.rs.age.intrxn.cm <- cv_plot(model.no.cong.rs.age.intrxn.results [[1]], fold_df)
```

```{r oos random age slope no cong,fig.height=3, fig.align="center", warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
model.no.cong.rs.age.intrxn.oos.cm <- cv_plot(model.no.cong.rs.age.intrxn.results[[1]], election2012)
```

```{r random age slope no intrxn no cong, fig.height=3, fig.align="center",warning=F,message=F,echo=FALSE,results='hide',fig.keep='all', cache=TRUE}
model.no.cong.random.slope.age.nointrxn.text <- "cbind(Likely,Unlikely) ~ age_bin + race_ethnicity + party_cd + gender + (1 + age_bin|county_desc)"
model.no.cong.rs.age.nointrxn.results <- create_model(model.no.cong.random.slope.age.nointrxn.text, fold_df, perform_cv = FALSE)
model.no.cong.rs.age.nointrxn.cm <- cv_plot(model.no.cong.rs.age.nointrxn.results[[1]], fold_df)
```

```{r oos random age slope no intrxn no cong,fig.height=3, fig.align="center", warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
model.no.cong.rs.age.nointrxn.oos.cm <- cv_plot(model.no.cong.rs.age.nointrxn.results[[1]], election2012)
```

```{r old model and party, fig.height=3, fig.align="center",warning=F,message=F,echo=FALSE,results='hide',fig.keep='all', cache=TRUE}
old.model.and.party.text <- "cbind(Likely,Unlikely) ~ age_bin * race_ethnicity + party_cd + gender + (1 | county_desc) + (1 | county_desc)"
old.model.and.party.results <- create_model(old.model.and.party.text, fold_df, perform_cv = FALSE)
old.model.and.party.cm <- cv_plot(old.model.and.party.results[[1]], fold_df)
```

```{r oos old model and party,fig.height=3, fig.align="center", warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
old.model.and.party.oos.cm <- cv_plot(old.model.and.party.results[[1]], election2012)
```

```{r, cache=T}
mod.ri.county.district.intrxn.age.race.party.race.text <- "cbind(Likely,Unlikely) ~ age_bin * race_ethnicity + gender + party_cd * race_ethnicity + (1 |county_desc) +  (1 | cong_dist_abbrv)"

mod.ri.county.rs.age.intrxn.age.race.results <- create_model(mod.ri.county.district.intrxn.age.race.party.race.text, fold_df, perform_cv = FALSE)
mod.ri.county.rs.age.intrxn.age.race.cm <- cv_plot(mod.ri.county.rs.age.intrxn.age.race.results[[1]], fold_df)
mod.ri.county.rs.age.intrxn.age.race.oos.cm <- cv_plot(mod.ri.county.rs.age.intrxn.age.race.results[[1]], election2012)
```

```{r, cache=T}
mod.ri.county.rs.party.district.intrxn.party.race.text <- "cbind(Likely,Unlikely) ~ age_bin + gender + party_cd * race_ethnicity + (1 |county_desc) +  (1 + party_cd | cong_dist_abbrv)"

mod.ri.county.rs.party.district.intrxn.party.race.results <- create_model(mod.ri.county.rs.party.district.intrxn.party.race.text, fold_df, perform_cv = FALSE)
mod.ri.county.rs.party.district.intrxn.party.race.cm <- cv_plot(mod.ri.county.rs.party.district.intrxn.party.race.results[[1]], fold_df)
mod.ri.county.rs.party.district.intrxn.party.race.oos.cm <- cv_plot(mod.ri.county.rs.party.district.intrxn.party.race.results[[1]], election2012)
```

## Final Model Results

```{r}
pander(final.model.fixed.results, caption="Final Model Results")
```

## Model Performance Summary

```{r model comparison table}
model_label <- function(model_text){
  return(substr(model_text,26,nchar(model_text)))
}
library(kableExtra)
model_performances <- data.frame(Interactions = c("None",
                                          "None",
                                          "Age * Race",
                                          "Age * Race",
                                          "None",
                                          "Age * Race",
                                          "Age * Race",
                                          "Age * Race",
                                          "Party * Race",
                                          "Age * Gender, Age * Race",
                                          "Age * Race, Gender * Race",
                                          "Age * Race, Party * Race",
                                          "Age * Race, Party * Race"),
                               Random.Intercept = c("County",
                                                    "District, County",
                                                    "County",
                                                    "County",
                                                    "District, County",
                                                    "District, County",
                                                    "District, County",
                                                    "District, County",
                                                    "District, County",
                                                    "District, County",
                                                    "District, County",
                                                    "District, County",
                                                    "District, County"),
                         Random.Slope = c("Age | County",
                                          "Age | County",
                                          "Age | County",
                                          "Race | County",
                                          "Age | District",
                                          "Age | District",
                                          "Gender | County",
                                          "Race | District",
                                          "Party | District",
                                          "None",
                                          "None",
                                          "None",
                                          "Age | County"),
                         In.F1=c(round(model.no.cong.rs.age.nointrxn.cm[[2]],3),
                                        round(model.rs.age.no.intrxn.cm[[2]],3),
                                        round(model.no.cong.rs.age.intrxn.cm[[2]],3),
                                        round(model.no.cong.rs.race.ethnicity.intrxn.cm[[2]],3),
                                        round(final.insample.results[[2]],3),
                                        round(model.rs.age.intrxn.cm[[2]],3),
                                        round(model.rs.gender.intrxn.cm[[2]],3),
                                        round(model.rs.race.ethnicity.intrxn.cm[[2]],3),
                                        round(mod.ri.county.rs.party.district.intrxn.party.race.cm[[2]], 3),
                                        round(model.intrxn.age.gender.cm[[2]],3),
                                        round(model.intrxn.re.gender.intrxn.cm[[2]],3),
                                        round(mod.ri.county.rs.age.intrxn.age.race.cm[[2]],3),
                                        round(model.rs.age.intrxn.re.party.cm[[2]],3)),
                         Out.F1=c(round(model.no.cong.rs.age.nointrxn.oos.cm[[2]],3),
                                        round(model.rs.age.no.intrxn.oos.cm[[2]],3),
                                        round(model.no.cong.rs.age.intrxn.oos.cm[[2]],3),
                                  round(model.no.cong.rs.race.ethnicity.intrxn.oos.cm[[2]],3),
                                        round(election2012.results[[2]],3),
                                        round(model.rs.age.intrxn.oos.cm[[2]],3),
                                        round(model.rs.gender.intrxn.oos.cm[[2]],3),
                                        round(model.rs.race.ethnicity.intrxn.oos.cm[[2]],3),
                                        round(mod.ri.county.rs.party.district.intrxn.party.race.oos.cm[[2]],3),
                                        round(model.intrxn.age.gender.oos.cm[[2]],3),
                                        round(model.rs.re.gender.intrxn.oos.cm[[2]],3),
                                        round(mod.ri.county.rs.age.intrxn.age.race.oos.cm[[2]],3),
                                        round(model.rs.age.intrxn.re.party.oos.cm[[2]],3)),
                         False.Negatives=c(round(model.no.cong.rs.age.nointrxn.cm[[5]],3),
                                        round(model.rs.age.no.intrxn.cm[[5]],3),
                                        round(model.no.cong.rs.age.intrxn.cm[[5]],3),
                                        round(model.no.cong.rs.race.ethnicity.intrxn.cm[[5]],3),
                                        round(final.insample.results[[5]],3),
                                        round(model.rs.age.intrxn.cm[[5]],3),
                                        round(model.rs.gender.intrxn.cm[[5]],3),
                                        round(model.rs.race.ethnicity.intrxn.cm[[5]],3),
                                        round(mod.ri.county.rs.party.district.intrxn.party.race.cm[[5]],3),
                                        round(model.intrxn.age.gender.cm[[5]],3),
                                        round(model.intrxn.re.gender.intrxn.cm[[5]],3),
                                        round(mod.ri.county.rs.age.intrxn.age.race.cm[[5]],3),
                                        round(model.rs.age.intrxn.re.party.cm[[5]],3)))
kable(model_performances, escape=F, booktabs = T, align = "lllccc", caption = "Model Performances") %>%
  kable_styling(latex_options = c("hold_position"))
```

```{r, eval=F}
model.rs.race.ethnicity.intrxn.cm[[3]]
model.rs.race.ethnicity.intrxn.results[[1]]
arm::binnedplot(x=cv_plot(model.rs.race.ethnicity.intrxn.results[[1]], fold_df)[[4]],
                                   y=residuals(model.rs.race.ethnicity.intrxn.results[[1]], "pearson"),
                                   xlab="Predicted Probabilities", 
                                   ylab="Binned Residuals",
                                   main = "Figure INVALID: Binned Residuals vs Predicted Probabilities",
                                   cex.main=0.9, cex.lab=0.8)
```


## Final Model Heatmaps

```{r heatmap county prop map, fig.width=5.5, fig.height=2.5,fig.align="center", warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
mod.res.map.3a
```

```{r heatmap results district prop map, fig.width=5.5, fig.height=2.5,fig.align="center", warning=F,message=F,echo=FALSE,results='hide',fig.keep='all'}
mod.res.map.3b + labs(caption="Figure 3b")
```

## Final Model Residuals

```{r}
arm::binnedplot(x=cv_plot(model.rs.age.no.intrxn.results[[1]], fold_df)[[4]],
                                   y=residuals(model.rs.age.no.intrxn.results[[1]], "pearson"),
                                   xlab="Predicted Probabilities", 
                                   ylab="Binned Residuals",
                                   main = "Figure 5: Binned Residuals vs Predicted Probabilities",
                                   cex.main=0.9, cex.lab=0.8)
fold_df_hold <- fold_df
fold_df_hold$r <- residuals(model.rs.age.no.intrxn.results[[1]], "pearson") < -2

party_residuals <- fold_df_hold %>%
  dplyr::group_by(r, party_cd) %>%
  dplyr::summarise(n = n()) %>%
  mutate(freq = n / sum(n))
```

```{r}
party_residuals <- party_residuals %>% filter(r==TRUE)
party_residuals_table <- subset(party_residuals, select=c(n,freq))
party_residuals_table$freq <- round(party_residuals_table$freq,3)
colnames(party_residuals_table) <- c("Count", "Frequency")
rownames(party_residuals_table) <- c("Democrat", "Republican", "Unaffiliated")
pander(party_residuals_table, "Extreme Residuals Distribution over Political Affiliation")
```

## Age Slope Over County Model

```{r}
pander(model.rs.age.no.intrxn.results[[3]], caption="Age Slope over Counties Model Results")
```

## Bayesian Approach: Coefficient Estimates of Final Model

```{r}
bayesian_model <- readRDS("brm1_interactions.Rds")
bayesian_table <- posterior_samples(bayesian_model, add_chain = T) %>% 
  dplyr::select(-lp__) %>% 
  gather(key, value, -chain, -iter) %>% 
  dplyr::select(-iter, -chain) %>% 
  mutate(key = as.factor(key)) %>% 
  filter(substr(key, 1,1) == "b") %>% 
  ungroup() %>% 
  mutate(key = str_remove_all(key, "b_")) %>% 
  dplyr::group_by(key) %>% 
  dplyr::summarise(Estimate = mean(value),
                   `Std.Err` = sd(value),
  ) %>% 
  dplyr::mutate(" " = key) %>% 
  dplyr::select(" ", Estimate, `Std.Err`) %>% 
  mutate_if(is.double, round, 4) %>% 
  pander(caption = "Bayesian Random County Intercept Model")
```

## Age Bin Sensitivity

```{r age bin sensitivity df, warning=F, cache=T}
who_votes_data_reaged <- who_votes_data
who_votes_data_reaged$age_bin <- as.character(who_votes_data_reaged$age_bin)
who_votes_data_reaged <- who_votes_data_reaged %>% mutate(age_bin = case_when(
  age_bin == "18-29" ~ "18-39",
  age_bin == "30-39" ~ "18-39",
  age_bin == "40-49" ~ "40-64",
  age_bin == "50-64" ~ "40-64",
  age_bin == "65+" ~ "65+",
  TRUE ~ age_bin))
who_votes_data_reaged <- who_votes_data_reaged %>% 
  dplyr::select(everything()) %>% 
  dplyr::group_by(county_desc,age_bin,race_ethnicity,gender,party_cd,cong_dist_abbrv) %>% 
  dplyr::summarise(Likely=sum(Likely),Unlikely=sum(Unlikely)) %>% ungroup() 
who_votes_data_reaged$age_bin <- relevel(who_votes_data_reaged$age_bin %>% as.factor(), ref = "65+")
who_votes_data_reaged$prop = who_votes_data_reaged$Likely/(who_votes_data_reaged$Likely + who_votes_data_reaged$Unlikely)

fold_df_reaged <- groupdata2::fold(who_votes_data_reaged, k = 5, cat_col = c("age_bin", "race_ethnicity", "gender","county_desc")) %>%
  dplyr::mutate(vote = ifelse(Likely/(Unlikely+Likely) > 0.5, 1, 0),
                vote = ifelse(is.nan(Likely/(Unlikely+Likely)), 0, vote),
                vote = dplyr::case_when(
                  Likely == 0 & Unlikely == 0 ~ 0,
                  TRUE ~ vote
                ))
reaged_results <- create_model(mod.ri.county.district.intrxn.age.race.party.race.text, 
                               fold_df_reaged, perform_cv=F)
pander(reaged_results[[3]], caption="Age Bin Sensitivity")
```


